name: Update gemini-cli flake on new release

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Check latest version
        id: version
        run: |
          LATEST=$(curl -s https://api.github.com/repos/google-gemini/gemini-cli/releases/latest | jq -r .tag_name | sed 's/^v//')
          CURRENT=$(grep -oP 'version = "\K[^"]+' flake.nix | head -1)
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "Latest: $LATEST — Current: $CURRENT"

      - name: Install Nix
        if: steps.version.outputs.latest != steps.version.outputs.current
        uses: DeterminateSystems/nix-installer-action@main

      - name: Update flake.nix
        if: steps.version.outputs.latest != steps.version.outputs.current
        run: |
          LATEST=${{ steps.version.outputs.latest }}

          sed -i "s|google/gemini-cli/v[0-9.]*|google-gemini/gemini-cli/$LATEST|" flake.nix
          sed -i "s|version = \"[0-9.]*\"|version = \"$LATEST\"|" flake.nix

          sed -i 's|npmDepsHash = "sha256-[^"]*"|npmDepsHash = "sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="|' flake.nix

          nix flake update

          NEW_HASH=$(nix build 2>&1 | grep "got:" | grep -oP 'sha256-\S+') || true

          sed -i "s|npmDepsHash = \"sha256-AAAA[^\"]*\"|npmDepsHash = \"$NEW_HASH\"|" flake.nix

      - name: Check nix build
        if: steps.version.outputs.latest != steps.version.outputs.current
        run: nix build

      - name: Open a new PR
        if: steps.version.outputs.latest != steps.version.outputs.current
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update gemini-cli to ${{ steps.version.outputs.latest }}"
          title: "Update gemini-cli to ${{ steps.version.outputs.latest }}"
          body: |
            New version detected : `${{ steps.version.outputs.latest }}`
            Old version : `${{ steps.version.outputs.current }}`

            ✅ Build passed.
          branch: update/gemini-cli-${{ steps.version.outputs.latest }}
